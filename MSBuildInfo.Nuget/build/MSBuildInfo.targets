<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <BuildInfoPath Condition="'$(BuildInfoPath)' == '' AND '$(_IsPublishing)' == 'true'">$(PublishDir)</BuildInfoPath>
    <BuildInfoPath Condition="'$(BuildInfoPath)' == ''">$(OutputPath)</BuildInfoPath>
    <BuildInfoName Condition="'$(BuildInfoName)' == ''">BuildInfo.json</BuildInfoName>
  </PropertyGroup>

  <Target Name="MSBuildInfoGenerate" DependsOnTargets="GenerateBuildInfo">
    <PropertyGroup>
      <BuildInfoTargetFramework Condition="'$(BuildInfoTargetFramework)' == ''">$(TargetFramework)</BuildInfoTargetFramework>
      <BuildInfoPlatform Condition="'$(BuildInfoPlatform)' == ''">$(Platform)</BuildInfoPlatform>
      <BuildInfoConfiguration Condition="'$(BuildInfoConfiguration)' == ''">$(Configuration)</BuildInfoConfiguration>
      <BuildInfoPackageId Condition="'$(BuildInfoPackageId)' == ''">$(PackageId)</BuildInfoPackageId>
      <BuildInfoVersion Condition="'$(BuildInfoVersion)' == ''">$(ApplicationVersion)</BuildInfoVersion>
      <BuildInfoDisplayVersion Condition="'$(BuildInfoDisplayVersion)' == ''">$(ApplicationDisplayVersion)</BuildInfoDisplayVersion>
      <BuildInfoFullVersion Condition="'$(BuildInfoFullVersion)' == ''">$(BuildInfoDisplayVersion).$(BuildInfoVersion)</BuildInfoFullVersion>
      <BuildInfoTitle Condition="'$(BuildInfoTitle)' == ''">$(ApplicationTitle)</BuildInfoTitle>

      <BuildInfoId Condition="'$(BuildInfoId)' == ''">$(_AndroidPackage)</BuildInfoId>
      <BuildInfoId Condition="'$(BuildInfoId)' == ''">$(_BundleIdentifier)</BuildInfoId>
      <BuildInfoId Condition="'$(BuildInfoId)' == ''">$(ApplicationId)</BuildInfoId>

      <BuildInfoPublishing>$(_IsPublishing)</BuildInfoPublishing>
      <BuildInfoPublishing Condition="'$(BuildInfoPublishing)' == ''">false</BuildInfoPublishing>

      <BuildInfoEnd>$([System.DateTime]::UtcNow.ToString("yyyy-MM-ddTHH:mm:ss.fffZ"))</BuildInfoEnd>
    </PropertyGroup>

    <ItemGroup>
      <BuildInfo Include="BuildStartTime" Value="$(BuildInfoStart)" />
      <BuildInfo Include="BuildEndTime" Value="$(BuildInfoEnd)" />
      <BuildInfo Include="TargetFramework" Value="$(BuildInfoTargetFramework)" />
      <BuildInfo Include="Platform" Value="$(BuildInfoPlatform)" />
      <BuildInfo Include="Configuration" Value="$(BuildInfoConfiguration)" />
      <BuildInfo Include="PackageId" Value="$(BuildInfoPackageId)" />
      <BuildInfo Include="Publishing" Value="$(BuildInfoPublishing)" />
      <BuildInfo Condition="'$(BuildInfoId)' != ''" Include="Id" Value="$(BuildInfoId)" />
      <BuildInfo Condition="'$(BuildInfoVersion)' != ''" Include="Version" Value="$(BuildInfoVersion)" />
      <BuildInfo Condition="'$(BuildInfoDisplayVersion)' != ''" Include="DisplayVersion" Value="$(BuildInfoDisplayVersion)" />
      <BuildInfo Condition="'$(BuildInfoFullVersion)' != ''" Include="FullVersion" Value="$(BuildInfoFullVersion)" />
      <BuildInfo Condition="'$(BuildInfoTitle)' != ''" Include="Title" Value="$(BuildInfoTitle)" />
    </ItemGroup>

    <CreateItem Include='"%(BuildInfo.Identity)": "%(BuildInfo.Value)"'>
      <Output TaskParameter="Include" ItemName="BuildInfoEntries" />
    </CreateItem>

    <PropertyGroup>
      <BuildInfoJson>
<![CDATA[
{
  @(BuildInfoEntries, ',
  ')
}
]]>
      </BuildInfoJson>
    </PropertyGroup>

    <WriteLinesToFile File="$(BuildInfoPath)/$(BuildInfoName)" Lines="$(BuildInfoJson)" Overwrite="true" Encoding="UTF-8" />
  </Target>


  <Target Name="MSBuildInfoBeforeBuild" BeforeTargets="Build" DependsOnTargets="RemoveBuildInfo">
    <ItemGroup>
      <BuildInfoFiles Include="$(BuildInfoPath)/$(BuildInfoName)" />
    </ItemGroup>
    <Delete Files="@(BuildInfoFiles)" />
  </Target>

  <Target Name="MSBuildInfoAfterBuild" AfterTargets="Build" DependsOnTargets="MSBuildInfoGenerate" />

  <!-- Targets for ad-hoc building -->
  <Target Name="BuildInfo" DependsOnTargets="MSBuildInfoGenerate" />
  <Target Name="MSBuildInfo" DependsOnTargets="MSBuildInfoGenerate" />

  <Import Condition="Exists('$(ProjectDir)BuildInfo.targets')" Project="$(ProjectDir)BuildInfo.targets" />
  <Import Condition="Exists('$(ProjectDir)MSBuildInfo.targets')" Project="$(ProjectDir)MSBuildInfo.targets" />
  <Import Condition="Exists('$(ProjectDir)BuildInfo.build.targets')" Project="$(ProjectDir)BuildInfo.build.targets" />
  <Import Condition="Exists('$(ProjectDir)MSBuildInfo.build.targets')" Project="$(ProjectDir)MSBuildInfo.build.targets" />

</Project>