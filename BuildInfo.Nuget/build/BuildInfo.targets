<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <UsingTask
    TaskName="BuildInfoTask"
    AssemblyFile="$(MSBuildThisFileDirectory)..\tools\BuildInfo.Tasks.dll" />

  <Target Name="BuildInfo_PostBuild" AfterTargets="Build">
    <PropertyGroup>
      <BuildInfoId Condition="'$(BuildInfoId)' == ''">$(_AndroidPackage)</BuildInfoId>
      <BuildInfoId Condition="'$(BuildInfoId)' == ''">$(_BundleIdentifier)</BuildInfoId>
      <BuildInfoId Condition="'$(BuildInfoId)' == ''">$(ApplicationId)</BuildInfoId>
      <BuildInfoVersion Condition="'$(BuildInfoVersion)' == ''">$(ApplicationVersion)</BuildInfoVersion>
      <BuildInfoDisplayVersion Condition="'$(BuildInfoDisplayVersion)' == ''">$(ApplicationDisplayVersion)</BuildInfoDisplayVersion>
      <BuildInfoTitle Condition="'$(BuildInfoTitle)' == ''">$(ApplicationTitle)</BuildInfoTitle>

      <BuildInfoVariant Condition="'$(BuildInfoDisplayVersion)' == ''">$(BuildVariant)</BuildInfoVariant>
      <BuildInfoVariant Condition="'$(BuildInfoVariant)' == ''">$(ApplicationVariant)</BuildInfoVariant>

      <BuildTargetFramework Condition="'$(BuildTargetFramework)' == ''">$(TargetFramework)</BuildTargetFramework>
    </PropertyGroup>
    <PropertyGroup>
      <BuildInfoPath Condition="'$(BuildInfoPath)' == ''">$(PublishDir)</BuildInfoPath>
      <BuildInfoPath Condition="'$(BuildInfoPath)' == ''">$(OutputPath)</BuildInfoPath>
      <BuildInfoName Condition="'$(BuildInfoName)' == ''">BuildInfo.json</BuildInfoName>
    </PropertyGroup>

    <ItemGroup>
      <BuildInfo Key="BuildTargetFramework" Include="$(BuildTargetFramework)" />
      <BuildInfo Key="BuildInfoId" Include="$(BuildInfoId)" />
      <BuildInfo Key="BuildInfoVersion" Include="$(BuildInfoVersion)" />
      <BuildInfo Key="BuildInfoDisplayVersion" Include="$(BuildInfoDisplayVersion)" />
      <BuildInfo Key="BuildInfoTitle" Include="$(BuildInfoTitle)" />
      <BuildInfo Key="BuildInfoVariant" Include="$(BuildInfoVariant)" />
      <BuildInfo Key="BuildInfoName" Include="$(BuildInfoName)" />
    </ItemGroup>

    <CreateItem Include='"%(BuildInfo.Key)": "%(BuildInfo.Identity)"'>
      <Output TaskParameter="Include" ItemName="BuildInfoJson" />
    </CreateItem>

    <CreateItem Include="{">
      <Output TaskParameter="Include" ItemName="BuildInfoJsonWrapped" />
    </CreateItem>
    <CreateItem Include="@(BuildInfoJson, ',&#x0A;')">
      <Output TaskParameter="Include" ItemName="BuildInfoJsonWrapped" />
    </CreateItem>
    <CreateItem Include="}">
      <Output TaskParameter="Include" ItemName="BuildInfoJsonWrapped" />
    </CreateItem>

    <WriteLinesToFile File="$(BuildInfoPath)/$(BuildInfoName)" Lines="@(BuildInfoJsonWrapped)" Overwrite="true" Encoding="UTF-8" />
  </Target>

</Project>